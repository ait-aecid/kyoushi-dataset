
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="IDS Dataset processing and labeling tool.">
      
      
      
      
        <link rel="canonical" href="https://ait-aecid.github.io/kyoushi-dataset/reference/labels/">
      
      <link rel="shortcut icon" href="../../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-6.2.8">
    
    
      
        <title>Labels - Cyber Range Kyoushi Dataset</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../stylesheets/jquery.fancybox.min.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="ait" data-md-color-primary="" data-md-color-accent="">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#labels-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://ait-aecid.github.io/kyoushi-dataset/" title="Cyber Range Kyoushi Dataset" class="md-header-nav__button md-logo" aria-label="Cyber Range Kyoushi Dataset">
      
  <img src="../../images/cr_icon.svg" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Cyber Range Kyoushi Dataset
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Labels
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/ait-aecid/kyoushi-dataset/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    kyoushi-dataset
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://ait-aecid.github.io/kyoushi-dataset/" title="Cyber Range Kyoushi Dataset" class="md-nav__button md-logo" aria-label="Cyber Range Kyoushi Dataset">
      
  <img src="../../images/cr_icon.svg" alt="logo">

    </a>
    Cyber Range Kyoushi Dataset
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/ait-aecid/kyoushi-dataset/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    kyoushi-dataset
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" >
      
      <label class="md-nav__link" for="nav-2">
        Getting Started
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="nav-2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/intro/" class="md-nav__link">
        Intro
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/prepare/" class="md-nav__link">
        Prepare Dataset
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/process/" class="md-nav__link">
        Process Dataset
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/label/" class="md-nav__link">
        Label Dataset
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/sample/" class="md-nav__link">
        Sample Labels
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
      
      <label class="md-nav__link" for="nav-3">
        Examples
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/process/" class="md-nav__link">
        Dataset Processing
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../processors/" class="md-nav__link">
        Dataset Processors
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../rules/" class="md-nav__link">
        Labeling Rules
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        CLI Reference
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
      
      <label class="md-nav__link" for="nav-7">
        Code Reference
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Code Reference" data-md-level="1">
        <label class="md-nav__title" for="nav-7">
          <span class="md-nav__icon md-icon"></span>
          Code Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        Config
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../elasticsearch/" class="md-nav__link">
        Elasticsearch
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Labels
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Labels
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels" class="md-nav__link">
    cr_kyoushi.dataset.labels
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase" class="md-nav__link">
    EqlQueryBase
  </a>
  
    <nav class="md-nav" aria-label="EqlQueryBase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.batch_size" class="md-nav__link">
    batch_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.by" class="md-nav__link">
    by
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.event_category_field" class="md-nav__link">
    event_category_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.max_result_window" class="md-nav__link">
    max_result_window
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.max_span" class="md-nav__link">
    max_span
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.sequences" class="md-nav__link">
    sequences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.tiebreaker_field" class="md-nav__link">
    tiebreaker_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.timestamp_field" class="md-nav__link">
    timestamp_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.until" class="md-nav__link">
    until
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule" class="md-nav__link">
    EqlSequenceRule
  </a>
  
    <nav class="md-nav" aria-label="EqlSequenceRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.batch_size" class="md-nav__link">
    batch_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.by" class="md-nav__link">
    by
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.event_category_field" class="md-nav__link">
    event_category_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.max_result_window" class="md-nav__link">
    max_result_window
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.max_span" class="md-nav__link">
    max_span
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.sequences" class="md-nav__link">
    sequences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.tiebreaker_field" class="md-nav__link">
    tiebreaker_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.timestamp_field" class="md-nav__link">
    timestamp_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.until" class="md-nav__link">
    until
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.LabelException" class="md-nav__link">
    LabelException
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler" class="md-nav__link">
    Labeler
  </a>
  
    <nav class="md-nav" aria-label="Labeler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler.add_label_object_mapping" class="md-nav__link">
    add_label_object_mapping()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler.execute" class="md-nav__link">
    execute()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler.write" class="md-nav__link">
    write()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule" class="md-nav__link">
    NoopRule
  </a>
  
    <nav class="md-nav" aria-label="NoopRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase" class="md-nav__link">
    QueryBase
  </a>
  
    <nav class="md-nav" aria-label="QueryBase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.exclude" class="md-nav__link">
    exclude
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.query" class="md-nav__link">
    query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.validate_exclude" class="md-nav__link">
    validate_exclude()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.validate_filter" class="md-nav__link">
    validate_filter()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.validate_queries" class="md-nav__link">
    validate_queries()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Rule" class="md-nav__link">
    Rule
  </a>
  
    <nav class="md-nav" aria-label="Rule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Rule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Rule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase" class="md-nav__link">
    RuleBase
  </a>
  
    <nav class="md-nav" aria-label="RuleBase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.validate_label_no_semicolon" class="md-nav__link">
    validate_label_no_semicolon()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleList" class="md-nav__link">
    RuleList
  </a>
  
    <nav class="md-nav" aria-label="RuleList">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleList.check_rule_ids_uniq" class="md-nav__link">
    check_rule_ids_uniq()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule" class="md-nav__link">
    UpdateByQueryRule
  </a>
  
    <nav class="md-nav" aria-label="UpdateByQueryRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.exclude" class="md-nav__link">
    exclude
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.query" class="md-nav__link">
    query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule" class="md-nav__link">
    UpdateParentQueryRule
  </a>
  
    <nav class="md-nav" aria-label="UpdateParentQueryRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.exclude" class="md-nav__link">
    exclude
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.max_result_window" class="md-nav__link">
    max_result_window
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.min_match" class="md-nav__link">
    min_match
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.parent_query" class="md-nav__link">
    parent_query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.query" class="md-nav__link">
    query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.check_parent" class="md-nav__link">
    check_parent()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule" class="md-nav__link">
    UpdateSubQueryRule
  </a>
  
    <nav class="md-nav" aria-label="UpdateSubQueryRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.exclude" class="md-nav__link">
    exclude
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.query" class="md-nav__link">
    query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.sub_query" class="md-nav__link">
    sub_query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.apply_labels_by_query" class="md-nav__link">
    apply_labels_by_query()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.apply_labels_by_update_dsl" class="md-nav__link">
    apply_labels_by_update_dsl()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.create_kyoushi_scripts" class="md-nav__link">
    create_kyoushi_scripts()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.get_label_counts" class="md-nav__link">
    get_label_counts()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.render_query_base" class="md-nav__link">
    render_query_base()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../parser/" class="md-nav__link">
        Parser
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../pcap/" class="md-nav__link">
        PCAP Utilities
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../processors/" class="md-nav__link">
        Processors
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../sample/" class="md-nav__link">
        Sampling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../templates/" class="md-nav__link">
        Templates
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        Utility Functions
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../license/" class="md-nav__link">
        License
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels" class="md-nav__link">
    cr_kyoushi.dataset.labels
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase" class="md-nav__link">
    EqlQueryBase
  </a>
  
    <nav class="md-nav" aria-label="EqlQueryBase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.batch_size" class="md-nav__link">
    batch_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.by" class="md-nav__link">
    by
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.event_category_field" class="md-nav__link">
    event_category_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.max_result_window" class="md-nav__link">
    max_result_window
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.max_span" class="md-nav__link">
    max_span
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.sequences" class="md-nav__link">
    sequences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.tiebreaker_field" class="md-nav__link">
    tiebreaker_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.timestamp_field" class="md-nav__link">
    timestamp_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.until" class="md-nav__link">
    until
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlQueryBase.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule" class="md-nav__link">
    EqlSequenceRule
  </a>
  
    <nav class="md-nav" aria-label="EqlSequenceRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.batch_size" class="md-nav__link">
    batch_size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.by" class="md-nav__link">
    by
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.event_category_field" class="md-nav__link">
    event_category_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.max_result_window" class="md-nav__link">
    max_result_window
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.max_span" class="md-nav__link">
    max_span
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.sequences" class="md-nav__link">
    sequences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.tiebreaker_field" class="md-nav__link">
    tiebreaker_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.timestamp_field" class="md-nav__link">
    timestamp_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.until" class="md-nav__link">
    until
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.query" class="md-nav__link">
    query()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.EqlSequenceRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.LabelException" class="md-nav__link">
    LabelException
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler" class="md-nav__link">
    Labeler
  </a>
  
    <nav class="md-nav" aria-label="Labeler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler.add_label_object_mapping" class="md-nav__link">
    add_label_object_mapping()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler.execute" class="md-nav__link">
    execute()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Labeler.write" class="md-nav__link">
    write()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule" class="md-nav__link">
    NoopRule
  </a>
  
    <nav class="md-nav" aria-label="NoopRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.NoopRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase" class="md-nav__link">
    QueryBase
  </a>
  
    <nav class="md-nav" aria-label="QueryBase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.exclude" class="md-nav__link">
    exclude
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.query" class="md-nav__link">
    query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.validate_exclude" class="md-nav__link">
    validate_exclude()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.validate_filter" class="md-nav__link">
    validate_filter()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.QueryBase.validate_queries" class="md-nav__link">
    validate_queries()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Rule" class="md-nav__link">
    Rule
  </a>
  
    <nav class="md-nav" aria-label="Rule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Rule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.Rule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase" class="md-nav__link">
    RuleBase
  </a>
  
    <nav class="md-nav" aria-label="RuleBase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleBase.validate_label_no_semicolon" class="md-nav__link">
    validate_label_no_semicolon()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleList" class="md-nav__link">
    RuleList
  </a>
  
    <nav class="md-nav" aria-label="RuleList">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.RuleList.check_rule_ids_uniq" class="md-nav__link">
    check_rule_ids_uniq()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule" class="md-nav__link">
    UpdateByQueryRule
  </a>
  
    <nav class="md-nav" aria-label="UpdateByQueryRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.exclude" class="md-nav__link">
    exclude
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.query" class="md-nav__link">
    query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule" class="md-nav__link">
    UpdateParentQueryRule
  </a>
  
    <nav class="md-nav" aria-label="UpdateParentQueryRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.exclude" class="md-nav__link">
    exclude
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.max_result_window" class="md-nav__link">
    max_result_window
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.min_match" class="md-nav__link">
    min_match
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.parent_query" class="md-nav__link">
    parent_query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.query" class="md-nav__link">
    query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.check_parent" class="md-nav__link">
    check_parent()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule" class="md-nav__link">
    UpdateSubQueryRule
  </a>
  
    <nav class="md-nav" aria-label="UpdateSubQueryRule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.description" class="md-nav__link">
    description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.exclude" class="md-nav__link">
    exclude
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.filter_" class="md-nav__link">
    filter_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.id_" class="md-nav__link">
    id_
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.index" class="md-nav__link">
    index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.indices_prefix_dataset" class="md-nav__link">
    indices_prefix_dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.labels" class="md-nav__link">
    labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.query" class="md-nav__link">
    query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.sub_query" class="md-nav__link">
    sub_query
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.type_field" class="md-nav__link">
    type_field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.update_params" class="md-nav__link">
    update_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.apply_labels_by_query" class="md-nav__link">
    apply_labels_by_query()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.apply_labels_by_update_dsl" class="md-nav__link">
    apply_labels_by_update_dsl()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.create_kyoushi_scripts" class="md-nav__link">
    create_kyoushi_scripts()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.get_label_counts" class="md-nav__link">
    get_label_counts()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cr_kyoushi.dataset.labels.render_query_base" class="md-nav__link">
    render_query_base()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ait-aecid/kyoushi-dataset/edit/main/docs/reference/labels.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="labels-module">Labels module<a class="headerlink" href="#labels-module" title="Permanent link">&para;</a></h1>


  <div class="doc doc-object doc-module">

<a id="cr_kyoushi.dataset.labels"></a>
    <div class="doc doc-contents first">

      <p>This module contains labeling rule implementations and utility
functions used during the labeling process</p>



  <div class="doc doc-children">











  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase">
        <code>
EqlQueryBase        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Pydantic model representing an EQL query</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.batch_size">
<code class="highlight language-python"><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.batch_size" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The amount of sequences to update with each batch. Cannot be bigger than <code>max_result_window</code></p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.by">
<code class="highlight language-python"><span class="n">by</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.by" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Optional global sequence by fields</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.event_category_field">
<code class="highlight language-python"><span class="n">event_category_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.event_category_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The field used to categories events</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.filter_">
<code class="highlight language-python"><span class="n">filter_</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.filter_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The filter/s to limit queried to documents to only those that match the filters</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.index">
<code class="highlight language-python"><span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The indices to query (by default prefixed with the dataset name)</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.indices_prefix_dataset">
<code class="highlight language-python"><span class="n">indices_prefix_dataset</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.indices_prefix_dataset" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>If set to true the <code>&lt;DATASET.name&gt;-</code> is automatically prefixed to each pattern. This is a convenience setting as per default all dataset indices start with this prefix.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.max_result_window">
<code class="highlight language-python"><span class="n">max_result_window</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.max_result_window" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The max result window allowed on the elasticsearch instance</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.max_span">
<code class="highlight language-python"><span class="n">max_span</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.max_span" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Optional max time span in which a sequence must occur to be considered a match</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.sequences">
<code class="highlight language-python"><span class="n">sequences</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.sequences" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Event sequences to search. Must contain at least two events.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.tiebreaker_field">
<code class="highlight language-python"><span class="n">tiebreaker_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.tiebreaker_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>(Optional, string) Field used to sort hits with the same timestamp in ascending order.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.timestamp_field">
<code class="highlight language-python"><span class="n">timestamp_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.timestamp_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The field containing the event timestamp</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.until">
<code class="highlight language-python"><span class="n">until</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.until" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Optional until event marking the end of valid sequences. The until event will not be labeled.</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlQueryBase.query">
<code class="highlight language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlQueryBase.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Converts the EQL query object into an EQL query string.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>The query in EQL syntax</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Converts the EQL query object into an EQL query string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The query in EQL syntax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;sequence&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">,</span> <span class="n">Text</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; by </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; with maxspan=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_span</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">until</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">until </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">until</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">query</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule">
        <code>
EqlSequenceRule        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Applies labels to a sequence of log events defined by an EQL query.</p>
<p>This labeling rule is defined as an
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/eql.html">EQL query</a>.
Using this syntax it is possible to define a sequence of related events and retrieve
them. All events part of retrieved sequences are then labeled.</p>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">elasticsearch.sequence</span><span class="w"></span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attacker.webshell.upload.seq</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">webshell_upload</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span><span class="w"></span>
<span class="w">    </span><span class="no">This rule labels the web shell upload step by matching the 3 step sequence</span><span class="w"></span>
<span class="w">    </span><span class="no">within the foothold phase.</span><span class="w"></span>
<span class="w">  </span><span class="nt">index</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache_access-intranet_server</span><span class="w"></span>
<span class="w">  </span><span class="c1"># since we do these requests very fast</span><span class="w"></span>
<span class="w">  </span><span class="c1"># we need the line number as tie breaker</span><span class="w"></span>
<span class="w">  </span><span class="nt">tiebreaker_field</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log.file.line</span><span class="w"></span>
<span class="w">  </span><span class="nt">by</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">source.address</span><span class="w"></span>
<span class="w">  </span><span class="nt">max_span</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2m</span><span class="w"></span>
<span class="w">  </span><span class="nt">filter</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">range</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;@timestamp&quot;</span><span class="p p-Indicator">:</span><span class="w"></span>
<span class="w">        </span><span class="c1"># foothold phase start</span><span class="w"></span>
<span class="w">        </span><span class="nt">gte</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2021-03-23</span><span class="nv"> </span><span class="s">20:31:00+00:00&quot;</span><span class="w"></span>
<span class="w">        </span><span class="c1"># foothold phase stop</span><span class="w"></span>
<span class="w">        </span><span class="nt">lte</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2021-03-23</span><span class="nv"> </span><span class="s">21:13:52+00:00&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">sequences</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;[</span><span class="nv"> </span><span class="s">apache</span><span class="nv"> </span><span class="s">where</span><span class="nv"> </span><span class="s">event.action</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;access&quot;</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">url.original</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;/&quot;</span><span class="nv"> </span><span class="s">]&#39;</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;[</span><span class="nv"> </span><span class="s">apache</span><span class="nv"> </span><span class="s">where</span><span class="nv"> </span><span class="s">event.action</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;access&quot;</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">url.original</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;/?p=5&quot;</span><span class="nv"> </span><span class="s">]&#39;</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;[</span><span class="nv"> </span><span class="s">apache</span><span class="nv"> </span><span class="s">where</span><span class="nv"> </span><span class="s">event.action</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;access&quot;</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">http.request.method</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;POST&quot;</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">url.original</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;/wp-admin/admin-ajax.php&quot;</span><span class="nv"> </span><span class="s">]&#39;</span><span class="w"></span>
</code></pre></div>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.batch_size">
<code class="highlight language-python"><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.batch_size" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The amount of sequences to update with each batch. Cannot be bigger than <code>max_result_window</code></p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.by">
<code class="highlight language-python"><span class="n">by</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.by" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Optional global sequence by fields</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.description">
<code class="highlight language-python"><span class="n">description</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.description" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>An optional description for the rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.event_category_field">
<code class="highlight language-python"><span class="n">event_category_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.event_category_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The field used to categories events</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.filter_">
<code class="highlight language-python"><span class="n">filter_</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.filter_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The filter/s to limit queried to documents to only those that match the filters</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.id_">
<code class="highlight language-python"><span class="n">id_</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.id_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The unique rule id</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.index">
<code class="highlight language-python"><span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The indices to query (by default prefixed with the dataset name)</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.indices_prefix_dataset">
<code class="highlight language-python"><span class="n">indices_prefix_dataset</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.indices_prefix_dataset" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>If set to true the <code>&lt;DATASET.name&gt;-</code> is automatically prefixed to each pattern. This is a convenience setting as per default all dataset indices start with this prefix.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.labels">
<code class="highlight language-python"><span class="n">labels</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.labels" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The list of labels to apply to log lines matching this rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.max_result_window">
<code class="highlight language-python"><span class="n">max_result_window</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.max_result_window" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The max result window allowed on the elasticsearch instance</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.max_span">
<code class="highlight language-python"><span class="n">max_span</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.max_span" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Optional max time span in which a sequence must occur to be considered a match</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.sequences">
<code class="highlight language-python"><span class="n">sequences</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.sequences" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Event sequences to search. Must contain at least two events.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.tiebreaker_field">
<code class="highlight language-python"><span class="n">tiebreaker_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.tiebreaker_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>(Optional, string) Field used to sort hits with the same timestamp in ascending order.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.timestamp_field">
<code class="highlight language-python"><span class="n">timestamp_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.timestamp_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The field containing the event timestamp</p>
    </div>

  </div>




  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.type_field">
<code class="highlight language-python"><span class="n">type_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.type_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The rule type as passed in from the config</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.until">
<code class="highlight language-python"><span class="n">until</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.until" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Optional until event marking the end of valid sequences. The until event will not be labeled.</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.apply">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">label_object</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.apply" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Applies the labels to all events part of retrieved sequences.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>dataset_dir</code></td>
        <td><code>Path</code></td>
        <td><p>The dataset base directory</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The label update script ID</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The field used to store label information</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of rows the labels were applied to.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Applies the labels to all events part of retrieved sequences.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_dir: The dataset base directory</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        update_script_id: The label update script ID</span>
<span class="sd">        label_object: The field used to store label information</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of rows the labels were applied to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">resolve_indices</span><span class="p">(</span>
        <span class="n">dataset_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices_prefix_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>

    <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_body</span><span class="p">(</span><span class="n">label_object</span><span class="p">)</span>

    <span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># as of elk 7.12 of there is no way to ensure we get all even through the EQL api</span>
    <span class="c1"># (there is no scan or search after like for the DSL API)</span>
    <span class="c1"># so manually search in batches for sequences with events that are not labeled yet</span>
    <span class="c1"># we stop only when we do not get any results anymore i.e., all events have been labeled</span>
    <span class="c1"># this is obviously not the most efficient approach but its the best we can do for now</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="n">search_eql</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hits</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">index_ids</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># we have to sort the events by indices</span>
            <span class="c1"># because ids are only guranteed to be uniq per index</span>
            <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">[</span><span class="s2">&quot;sequences&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]:</span>
                    <span class="n">index_ids</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;_index&quot;</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
            <span class="c1"># add labels to each event per index</span>
            <span class="k">for</span> <span class="n">_index</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">index_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># split the update requests into chunks of at most max result window</span>
                <span class="n">update_chunks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ids</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_result_window</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_result_window</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">update_chunks</span><span class="p">:</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="n">UpdateByQuery</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">_index</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">chunk</span>
                    <span class="p">)</span>
                    <span class="c1"># apply labels to events</span>
                    <span class="n">updated</span> <span class="o">+=</span> <span class="n">apply_labels_by_update_dsl</span><span class="p">(</span>
                        <span class="n">update</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_params</span><span class="p">(),</span> <span class="n">update_script_id</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># end loop once we do not find new events anymore</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">updated</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.query">
<code class="highlight language-python"><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-inherited"><code>inherited</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Converts the EQL query object into an EQL query string.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>The query in EQL syntax</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Converts the EQL query object into an EQL query string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The query in EQL syntax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;sequence&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">,</span> <span class="n">Text</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; by </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; with maxspan=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_span</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">until</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">until </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">until</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">query</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.EqlSequenceRule.update_params">
<code class="highlight language-python"><span class="n">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-inherited"><code>inherited</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.EqlSequenceRule.update_params" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Gets the update script parameters required for this rule.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, Any]</code></td>
      <td><p>The update script parameters.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets the update script parameters required for this rule.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The update script parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.LabelException">
        <code>
LabelException        </code>



<a class="headerlink" href="#cr_kyoushi.dataset.labels.LabelException" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Generic exception for errors during labeling phase.</p>



    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.Labeler">
        <code>
Labeler        </code>



<a class="headerlink" href="#cr_kyoushi.dataset.labels.Labeler" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Cyber Range Kyoushi labeler</p>
<p>This class is used to configure and execute
the labeling process.</p>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.Labeler.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_types</span><span class="o">=</span><span class="p">{},</span> <span class="n">update_script_id</span><span class="o">=</span><span class="s1">&#39;kyoushi_label_update&#39;</span><span class="p">,</span> <span class="n">label_object</span><span class="o">=</span><span class="s1">&#39;kyoushi_labels&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.Labeler.__init__" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>rule_types</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>Dictionary containing all available labeling rule types.</p></td>
        <td><code>{}</code></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The Elasticsearch ID for the update script.</p></td>
        <td><code>&#39;kyoushi_label_update&#39;</code></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The field to store labels in.</p></td>
        <td><code>&#39;kyoushi_labels&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">rule_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kyoushi_label_update&quot;</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kyoushi_labels&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        rule_types : Dictionary containing all available labeling rule types.</span>
<span class="sd">        update_script_id: The Elasticsearch ID for the update script.</span>
<span class="sd">        label_object: The field to store labels in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rule_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule_types</span>
    <span class="c1"># default rule types</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rule_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">NoopRule</span><span class="o">.</span><span class="n">type_</span><span class="p">:</span> <span class="n">NoopRule</span><span class="p">,</span>
            <span class="n">UpdateByQueryRule</span><span class="o">.</span><span class="n">type_</span><span class="p">:</span> <span class="n">UpdateByQueryRule</span><span class="p">,</span>
            <span class="n">UpdateSubQueryRule</span><span class="o">.</span><span class="n">type_</span><span class="p">:</span> <span class="n">UpdateSubQueryRule</span><span class="p">,</span>
            <span class="n">UpdateParentQueryRule</span><span class="o">.</span><span class="n">type_</span><span class="p">:</span> <span class="n">UpdateParentQueryRule</span><span class="p">,</span>
            <span class="n">EqlSequenceRule</span><span class="o">.</span><span class="n">type_</span><span class="p">:</span> <span class="n">EqlSequenceRule</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">update_script_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">label_object</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.Labeler.add_label_object_mapping">
<code class="highlight language-python"><span class="n">add_label_object_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">rules</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.Labeler.add_label_object_mapping" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Utility function for adding the field definitions for the label field.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_name</code></td>
        <td><code>str</code></td>
        <td><p>The name of the dataset.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>rules</code></td>
        <td><code>List[cr_kyoushi.dataset.labels.Rule]</code></td>
        <td><p>List of all to be applied rules.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_label_object_mapping</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">rules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Rule</span><span class="p">],</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Utility function for adding the field definitions for the label field.</span>

<span class="sd">    Args:</span>
<span class="sd">        es: The elasticsearch client object.</span>
<span class="sd">        dataset_name: The name of the dataset.</span>
<span class="sd">        rules: List of all to be applied rules.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">()</span>
    <span class="n">flat</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
        <span class="n">flat</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">()</span>
        <span class="n">list_</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">Keyword</span><span class="p">(</span><span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;flat&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">flat</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;list&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">list_</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;rules&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="n">root</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_object</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">)</span>
    <span class="n">es</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">put_mapping</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">-*&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">root</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.Labeler.execute">
<code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.Labeler.execute" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Parse and apply all labeling rules.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function only write labels to the database.
The resulting labels can be written to the file system
using the <code>write(...)</code> function of the labeler.</p>
</div>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>rules</code></td>
        <td><code>List[Dict[str, Any]]</code></td>
        <td><p>The unparsed list of labeling rules.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_dir</code></td>
        <td><code>Path</code></td>
        <td><p>The dataset path</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValidationError</code></td>
        <td><p>If a labeling rule or configuration is invalid</p></td>
      </tr>
      <tr>
        <td><code>LabelException</code></td>
        <td><p>If an error occurs while applying a labeling rule</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">rules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse and apply all labeling rules.</span>

<span class="sd">    !!! Note</span>
<span class="sd">        This function only write labels to the database.</span>
<span class="sd">        The resulting labels can be written to the file system</span>
<span class="sd">        using the `write(...)` function of the labeler.</span>

<span class="sd">    Args:</span>
<span class="sd">        rules: The unparsed list of labeling rules.</span>
<span class="sd">        dataset_dir: The dataset path</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValidationError: If a labeling rule or configuration is invalid</span>
<span class="sd">        LabelException: If an error occurs while applying a labeling rule</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># validate the general rule list</span>
    <span class="n">RuleList</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>

    <span class="c1"># convert and validate rule types</span>
    <span class="n">rule_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Rule</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ErrorWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rule_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_types</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ErrorWrapper</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">RuleList</span><span class="p">)</span>

    <span class="c1"># create mappings for rule label fields</span>
    <span class="c1"># we need to do this since EQL queries cannot check existence of non mapped fields</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_label_object_mapping</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">dataset_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rule_objects</span><span class="p">)</span>

    <span class="c1"># ensure update script exists</span>
    <span class="n">create_kyoushi_scripts</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">dataset_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_object</span><span class="p">)</span>

    <span class="c1"># start labeling process</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rule_objects</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying rule </span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="n">dataset_dir</span><span class="p">,</span>
                <span class="n">dataset_config</span><span class="p">,</span>
                <span class="n">es</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">update_script_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_object</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Rule </span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2"> applied labels: </span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="n">labels</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">updated</span><span class="si">}</span><span class="s2"> lines.&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ElasticsearchRequestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LabelException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing rule &#39;</span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.Labeler.write">
<code class="highlight language-python"><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">skip_files</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.Labeler.write" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Write labeles stored in the database to the file system.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>dataset_dir</code></td>
        <td><code>Path</code></td>
        <td><p>The dataset path</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>index</code></td>
        <td><code>List[str]</code></td>
        <td><p>The indices to consider</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>skip_files</code></td>
        <td><code>List[str]</code></td>
        <td><p>The files to ignore</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">write</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">skip_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write labeles stored in the database to the file system.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_dir: The dataset path</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        index: The indices to consider</span>
<span class="sd">        skip_files: The files to ignore</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_label_files</span><span class="p">(</span><span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">skip_files</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">current_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="c1"># disable request cache to ensure we always get latest info</span>
        <span class="n">search_labeled</span> <span class="o">=</span> <span class="n">Search</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">params</span><span class="p">(</span>
            <span class="n">request_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve_order</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">search_labeled</span> <span class="o">=</span> <span class="n">search_labeled</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="s2">&quot;exists&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label_object</span><span class="si">}</span><span class="s2">.rules&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s2">&quot;term&quot;</span><span class="p">,</span> <span class="n">log__file__path</span><span class="o">=</span><span class="n">current_file</span><span class="p">)</span>

        <span class="n">search_labeled</span> <span class="o">=</span> <span class="n">search_labeled</span><span class="o">.</span><span class="n">sort</span><span class="p">({</span><span class="s2">&quot;log.file.line&quot;</span><span class="p">:</span> <span class="s2">&quot;asc&quot;</span><span class="p">})</span>

        <span class="n">base_path</span> <span class="o">=</span> <span class="n">dataset_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">LAYOUT</span><span class="o">.</span><span class="n">GATHER</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">label_path</span> <span class="o">=</span> <span class="n">dataset_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">LAYOUT</span><span class="o">.</span><span class="n">LABELS</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">label_file_path</span> <span class="o">=</span> <span class="n">label_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">current_file</span><span class="p">)</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start writing </span><span class="si">{</span><span class="n">current_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_file</span><span class="p">(</span><span class="n">search_labeled</span><span class="p">,</span> <span class="n">label_file_path</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.NoopRule">
        <code>
NoopRule        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.NoopRule" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>A noop rule that does absolutely nothing.</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.NoopRule.description">
<code class="highlight language-python"><span class="n">description</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.NoopRule.description" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>An optional description for the rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.NoopRule.id_">
<code class="highlight language-python"><span class="n">id_</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.NoopRule.id_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The unique rule id</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.NoopRule.labels">
<code class="highlight language-python"><span class="n">labels</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.NoopRule.labels" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The list of labels to apply to log lines matching this rule</p>
    </div>

  </div>




  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.NoopRule.type_field">
<code class="highlight language-python"><span class="n">type_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.NoopRule.type_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The rule type as passed in from the config</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.NoopRule.apply">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">label_object</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.NoopRule.apply" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Applies the NoopRule i.e., does nothing.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>dataset_dir</code></td>
        <td><code>Path</code></td>
        <td><p>The dataset base directory</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The label update script ID</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The field used to store label information</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>Always returns 0 since nothing happens.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Applies the NoopRule i.e., does nothing.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_dir: The dataset base directory</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        update_script_id: The label update script ID</span>
<span class="sd">        label_object: The field used to store label information</span>

<span class="sd">    Returns:</span>
<span class="sd">        Always returns 0 since nothing happens.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.NoopRule.update_params">
<code class="highlight language-python"><span class="n">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-inherited"><code>inherited</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.NoopRule.update_params" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Gets the update script parameters required for this rule.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, Any]</code></td>
      <td><p>The update script parameters.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets the update script parameters required for this rule.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The update script parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.QueryBase">
        <code>
QueryBase        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.QueryBase" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Base model for DSL query based labeling rules</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.QueryBase.exclude">
<code class="highlight language-python"><span class="n">exclude</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.QueryBase.exclude" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Similar to filters, but used to exclude results</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.QueryBase.filter_">
<code class="highlight language-python"><span class="n">filter_</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.QueryBase.filter_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The filter/s to limit queried to documents to only those that match the filters</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.QueryBase.index">
<code class="highlight language-python"><span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.QueryBase.index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The indices to query (by default prefixed with the dataset name)</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.QueryBase.indices_prefix_dataset">
<code class="highlight language-python"><span class="n">indices_prefix_dataset</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.QueryBase.indices_prefix_dataset" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>If set to true the <code>&lt;DATASET.name&gt;-</code> is automatically prefixed to each pattern. This is a convenience setting as per default all dataset indices start with this prefix.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.QueryBase.query">
<code class="highlight language-python"><span class="n">query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.QueryBase.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The query/s to use for identifying log lines to apply the tags to.</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.QueryBase.validate_exclude">
<code class="highlight language-python"><span class="n">validate_exclude</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.QueryBase.validate_exclude" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Validator to check the DSL query exclude syntax</p>
<p>Exclude is simply a negative filter clause i.e.,
not (DSL QUERY).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>value</code></td>
        <td><code>Union[List[Dict[str, Any]], Dict[str, Any]]</code></td>
        <td><p>The DSL exclude</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>values</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>The model dictionary</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValidationError</code></td>
        <td><p>Should the exclude not be valid</p></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Union[List[Dict[str, Any]], Dict[str, Any]]</code></td>
      <td><p>The validated exclude</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">validate_exclude</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Validator to check the DSL query exclude syntax</span>

<span class="sd">    Exclude is simply a negative filter clause i.e.,</span>
<span class="sd">    not (DSL QUERY).</span>

<span class="sd">    Args:</span>
<span class="sd">        value: The DSL exclude</span>
<span class="sd">        values: The model dictionary</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValidationError: Should the exclude not be valid</span>

<span class="sd">    Returns:</span>
<span class="sd">        The validated exclude</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># temporary update by query object used to validate the input excludes</span>
    <span class="n">_temp</span> <span class="o">=</span> <span class="n">UpdateByQuery</span><span class="p">()</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exclude</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_temp</span> <span class="o">=</span> <span class="n">_temp</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">UnknownDslObject</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ErrorWrapper</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">UpdateByQueryRule</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.QueryBase.validate_filter">
<code class="highlight language-python"><span class="n">validate_filter</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.QueryBase.validate_filter" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Validator to check the DSL query filter syntax</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>value</code></td>
        <td><code>Union[List[Dict[str, Any]], Dict[str, Any]]</code></td>
        <td><p>The DSL filter</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>values</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>The model dictionary</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValidationError</code></td>
        <td><p>Should the filter not be valid</p></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Union[List[Dict[str, Any]], Dict[str, Any]]</code></td>
      <td><p>The validated filter</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;filter_&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">validate_filter</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Validator to check the DSL query filter syntax</span>

<span class="sd">    Args:</span>
<span class="sd">        value: The DSL filter</span>
<span class="sd">        values: The model dictionary</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValidationError: Should the filter not be valid</span>

<span class="sd">    Returns:</span>
<span class="sd">        The validated filter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># temporary update by query object used to validate the input filters</span>
    <span class="n">_temp</span> <span class="o">=</span> <span class="n">UpdateByQuery</span><span class="p">()</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filter_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_temp</span> <span class="o">=</span> <span class="n">_temp</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">UnknownDslObject</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ErrorWrapper</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">UpdateByQueryRule</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.QueryBase.validate_queries">
<code class="highlight language-python"><span class="n">validate_queries</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.QueryBase.validate_queries" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Validator checking DSL syntax</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>value</code></td>
        <td><code>Union[List[Dict[str, Any]], Dict[str, Any]]</code></td>
        <td><p>The DSL query</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>values</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>The model dictionary</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValidationError</code></td>
        <td><p>Should the given query be invalid</p></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Union[List[Dict[str, Any]], Dict[str, Any]]</code></td>
      <td><p>The validated query</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">validate_queries</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Validator checking DSL syntax</span>

<span class="sd">    Args:</span>
<span class="sd">        value: The DSL query</span>
<span class="sd">        values: The model dictionary</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValidationError: Should the given query be invalid</span>

<span class="sd">    Returns:</span>
<span class="sd">        The validated query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># temporary update by query object used to validate the input queries</span>
    <span class="n">_temp</span> <span class="o">=</span> <span class="n">UpdateByQuery</span><span class="p">()</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_temp</span> <span class="o">=</span> <span class="n">_temp</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">UnknownDslObject</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ErrorWrapper</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">UpdateByQueryRule</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.Rule">
        <code>
Rule        </code>



<a class="headerlink" href="#cr_kyoushi.dataset.labels.Rule" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Interface definition for labeling rules.</p>




  <div class="doc doc-children">














  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.Rule.apply">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">label_object</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.Rule.apply" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Applies the configured rule and assigns the labels to all matching rows.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>dataset_dir</code></td>
        <td><code>Path</code></td>
        <td><p>The dataset base directory</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The label update script ID</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The field used to store label information</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of rows the rule was applied to</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Applies the configured rule and assigns the labels to all matching rows.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_dir: The dataset base directory</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        update_script_id: The label update script ID</span>
<span class="sd">        label_object: The field used to store label information</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of rows the rule was applied to</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.Rule.update_params">
<code class="highlight language-python"><span class="n">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.Rule.update_params" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Gets the update script parameters required for this rule.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, Any]</code></td>
      <td><p>The update script parameters.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets the update script parameters required for this rule.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The update script parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleBase">
        <code>
RuleBase        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleBase" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Pydantic base model for labeling rules.</p>
<p>This class can be extended to define custom labeling rules.</p>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleBase.description">
<code class="highlight language-python"><span class="n">description</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleBase.description" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>An optional description for the rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleBase.id_">
<code class="highlight language-python"><span class="n">id_</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleBase.id_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The unique rule id</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleBase.labels">
<code class="highlight language-python"><span class="n">labels</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleBase.labels" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The list of labels to apply to log lines matching this rule</p>
    </div>

  </div>




  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleBase.type_field">
<code class="highlight language-python"><span class="n">type_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleBase.type_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The rule type as passed in from the config</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleBase.apply">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">label_object</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleBase.apply" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Applies the configured rule and assigns the labels to all matching rows.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>dataset_dir</code></td>
        <td><code>Path</code></td>
        <td><p>The dataset base directory</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The label update script ID</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The field used to store label information</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of rows the rule was applied to</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Applies the configured rule and assigns the labels to all matching rows.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_dir: The dataset base directory</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        update_script_id: The label update script ID</span>
<span class="sd">        label_object: The field used to store label information</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of rows the rule was applied to</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleBase.update_params">
<code class="highlight language-python"><span class="n">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleBase.update_params" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Gets the update script parameters required for this rule.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, Any]</code></td>
      <td><p>The update script parameters.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets the update script parameters required for this rule.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The update script parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleBase.validate_label_no_semicolon">
<code class="highlight language-python"><span class="n">validate_label_no_semicolon</span><span class="p">(</span><span class="n">val</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleBase.validate_label_no_semicolon" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Validator ensuring label names do not contain <code>;</code>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>val</code></td>
        <td><code>str</code></td>
        <td><p>A single label</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>The validated label</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">each_item</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">validate_label_no_semicolon</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Validator ensuring label names do not contain `;`.</span>

<span class="sd">    Args:</span>
<span class="sd">        val: A single label</span>

<span class="sd">    Returns:</span>
<span class="sd">        The validated label</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Labels must not contain semicolons, but got &#39;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">return</span> <span class="n">val</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleList">
        <code>
RuleList        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleList" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Model definition of a list of labeling rules.</p>




  <div class="doc doc-children">













  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.RuleList.check_rule_ids_uniq">
<code class="highlight language-python"><span class="n">check_rule_ids_uniq</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.RuleList.check_rule_ids_uniq" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Validator for ensuring that rule IDs are unique.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>values</code></td>
        <td><code>Dict[str, List[cr_kyoushi.dataset.labels.RuleBase]]</code></td>
        <td><p>The model dictionary</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, List[cr_kyoushi.dataset.labels.RuleBase]]</code></td>
      <td><p>The validated model dictionary</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@root_validator</span>
<span class="k">def</span> <span class="nf">check_rule_ids_uniq</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">RuleBase</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">RuleBase</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Validator for ensuring that rule IDs are unique.</span>

<span class="sd">    Args:</span>
<span class="sd">        values: The model dictionary</span>

<span class="sd">    Returns:</span>
<span class="sd">        The validated model dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;__root__&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;__root__&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">id_</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id_</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Rule IDs must be uniq, but got duplicates: </span><span class="si">{</span><span class="n">duplicates</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">values</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule">
        <code>
UpdateByQueryRule        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Applies labels based on a simple Elasticsearch DSL query.</p>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">elasticsearch.query</span><span class="w"></span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attacker.foothold.vpn.ip</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attacker_vpn</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foothold</span><span class="w"></span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span><span class="w"></span>
<span class="w">    </span><span class="no">This rule applies the labels to all openvpn log rows that have</span><span class="w"></span>
<span class="w">    </span><span class="no">the attacker server as source ip and are within the foothold phase.</span><span class="w"></span>
<span class="w">  </span><span class="nt">index</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openvpn-vpn</span><span class="w"></span>
<span class="w">  </span><span class="nt">filter</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">range</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;@timestamp&quot;</span><span class="p p-Indicator">:</span><span class="w"></span>
<span class="w">        </span><span class="c1"># foothold phase start</span><span class="w"></span>
<span class="w">        </span><span class="nt">gte</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2021-03-23</span><span class="nv"> </span><span class="s">20:31:00+00:00&quot;</span><span class="w"></span>
<span class="w">        </span><span class="c1"># foothold phase stop</span><span class="w"></span>
<span class="w">        </span><span class="nt">lte</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2021-03-23</span><span class="nv"> </span><span class="s">21:13:52+00:00&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">query</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">source.ip</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;192.42.0.255&#39;</span><span class="w"></span>
</code></pre></div>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.description">
<code class="highlight language-python"><span class="n">description</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.description" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>An optional description for the rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.exclude">
<code class="highlight language-python"><span class="n">exclude</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.exclude" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Similar to filters, but used to exclude results</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.filter_">
<code class="highlight language-python"><span class="n">filter_</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.filter_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The filter/s to limit queried to documents to only those that match the filters</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.id_">
<code class="highlight language-python"><span class="n">id_</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.id_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The unique rule id</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.index">
<code class="highlight language-python"><span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The indices to query (by default prefixed with the dataset name)</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.indices_prefix_dataset">
<code class="highlight language-python"><span class="n">indices_prefix_dataset</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.indices_prefix_dataset" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>If set to true the <code>&lt;DATASET.name&gt;-</code> is automatically prefixed to each pattern. This is a convenience setting as per default all dataset indices start with this prefix.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.labels">
<code class="highlight language-python"><span class="n">labels</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.labels" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The list of labels to apply to log lines matching this rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.query">
<code class="highlight language-python"><span class="n">query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The query/s to use for identifying log lines to apply the tags to.</p>
    </div>

  </div>




  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.type_field">
<code class="highlight language-python"><span class="n">type_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.type_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The rule type as passed in from the config</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.apply">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">label_object</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.apply" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Applies the labels to all rows matching the DSL query.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>dataset_dir</code></td>
        <td><code>Path</code></td>
        <td><p>The dataset base directory</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The label update script ID</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The field used to store label information</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of rows the labels were applied to.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Applies the labels to all rows matching the DSL query.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_dir: The dataset base directory</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        update_script_id: The label update script ID</span>
<span class="sd">        label_object: The field used to store label information</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of rows the labels were applied to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">resolve_indices</span><span class="p">(</span>
        <span class="n">dataset_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices_prefix_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">UpdateByQuery</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># ensure we have lists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="c1"># exclude already correctly labeled rows from the result set</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
        <span class="s2">&quot;term&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_object</span><span class="si">}</span><span class="s2">.flat.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)},</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">_query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_</span><span class="p">:</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_filter</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_exclude</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">_exclude</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">apply_labels_by_update_dsl</span><span class="p">(</span>
        <span class="n">update</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_params</span><span class="p">(),</span> <span class="n">update_script_id</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateByQueryRule.update_params">
<code class="highlight language-python"><span class="n">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-inherited"><code>inherited</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateByQueryRule.update_params" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Gets the update script parameters required for this rule.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, Any]</code></td>
      <td><p>The update script parameters.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets the update script parameters required for this rule.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The update script parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule">
        <code>
UpdateParentQueryRule        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Applies the labels to all rows of a base query for which
a parent query returns results.</p>
<p>This labeling rule first executes a base query to retrieve rows we might want
to apply labels to. It then renders and executes a templated parent query
for each retrieved row. The parent queries are then used to indicate if
the initial result row should be labeled or not. By default result rows of the
base query are labeled if the corresponding parent query returns at leas <em>one</em>
row. It is possible to configure this minimum number e.g., to require at least
two results.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The sub query uses Jinja2 syntax for templating. The information retrieved
by the base query can be accessed through the <code>HIT</code> variable.</p>
</div>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">elasticsearch.parent_query</span><span class="w"></span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attacker.foothold.apache.error_access</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attacker_http</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foothold</span><span class="w"></span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span><span class="w"></span>
<span class="w">    </span><span class="no">This rule looks for unlabeled error messages resulting from VPN server</span><span class="w"></span>
<span class="w">    </span><span class="no">traffic within the attack time and tries to match it to an already labeled</span><span class="w"></span>
<span class="w">    </span><span class="no">access log row.</span><span class="w"></span>
<span class="w">  </span><span class="nt">index</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache_error-intranet_server</span><span class="w"></span>
<span class="w">  </span><span class="nt">query</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">source.address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;172.16.100.151&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">filter</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="c1"># use script query to match only entries that</span><span class="w"></span>
<span class="w">    </span><span class="c1"># are not already tagged for as attacker http in the foothold phase</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">bool</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">must_not</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">script</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_dataset_kyoushi_label_filter</span><span class="w"></span>
<span class="w">                </span><span class="nt">params</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">attacker_http</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">  </span><span class="nt">parent_query</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">index</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache_access-intranet_server</span><span class="w"></span>
<span class="w">    </span><span class="nt">query</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">term</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">url.full</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">HIT.url.full</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">term</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">source.address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">HIT.source.address</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<span class="w">    </span><span class="c1"># we are looking for parents that are labeled as attacker http</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">bool</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">must</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="nt">script</span><span class="p">:</span><span class="w"></span>
<span class="w">                  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_dataset_kyoushi_label_filter</span><span class="w"></span>
<span class="w">                  </span><span class="nt">params</span><span class="p">:</span><span class="w"></span>
<span class="w">                    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">attacker_http</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">filter</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">range</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="c1"># parent must be within +-1s of potential child</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;@timestamp&quot;</span><span class="p p-Indicator">:</span><span class="w"></span>
<span class="w">             </span><span class="nt">gte</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">(HIT[&#39;@timestamp&#39;]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">as_datetime)</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">timedelta(seconds=1)</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<span class="w">             </span><span class="nt">lte</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">(</span><span class="nv"> </span><span class="s">HIT[&#39;@timestamp&#39;]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">as_datetime)</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">timedelta(seconds=1)</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
</code></pre></div>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.description">
<code class="highlight language-python"><span class="n">description</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.description" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>An optional description for the rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.exclude">
<code class="highlight language-python"><span class="n">exclude</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.exclude" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Similar to filters, but used to exclude results</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.filter_">
<code class="highlight language-python"><span class="n">filter_</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.filter_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The filter/s to limit queried to documents to only those that match the filters</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.id_">
<code class="highlight language-python"><span class="n">id_</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.id_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The unique rule id</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.index">
<code class="highlight language-python"><span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The indices to query (by default prefixed with the dataset name)</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.indices_prefix_dataset">
<code class="highlight language-python"><span class="n">indices_prefix_dataset</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.indices_prefix_dataset" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>If set to true the <code>&lt;DATASET.name&gt;-</code> is automatically prefixed to each pattern. This is a convenience setting as per default all dataset indices start with this prefix.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.labels">
<code class="highlight language-python"><span class="n">labels</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.labels" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The list of labels to apply to log lines matching this rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.max_result_window">
<code class="highlight language-python"><span class="n">max_result_window</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.max_result_window" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The max result window allowed on the elasticsearch instance</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.min_match">
<code class="highlight language-python"><span class="n">min_match</span><span class="p">:</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.min_match" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The minimum number of parent matches needed for the main query to be labeled.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.parent_query">
<code class="highlight language-python"><span class="n">parent_query</span><span class="p">:</span> <span class="n">QueryBase</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.parent_query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The templated parent query to check if the labels should be applied to a query hit.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.query">
<code class="highlight language-python"><span class="n">query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The query/s to use for identifying log lines to apply the tags to.</p>
    </div>

  </div>




  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.type_field">
<code class="highlight language-python"><span class="n">type_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.type_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The rule type as passed in from the config</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.apply">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">label_object</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.apply" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Applies the labels to result from the base query for which a parent was found.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>dataset_dir</code></td>
        <td><code>Path</code></td>
        <td><p>The dataset base directory</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The label update script ID</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The field used to store label information</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of rows the labels were applied to.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Applies the labels to result from the base query for which a parent was found.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_dir: The dataset base directory</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        update_script_id: The label update script ID</span>
<span class="sd">        label_object: The field used to store label information</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of rows the labels were applied to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">resolve_indices</span><span class="p">(</span>
        <span class="n">dataset_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices_prefix_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">Search</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># ensure we have lists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="c1"># exclude already correctly labeled rows from the result set</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
        <span class="s2">&quot;term&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_object</span><span class="si">}</span><span class="s2">.flat.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)},</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">_query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_filter</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_exclude</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">_exclude</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">scan</span><span class="p">():</span>
        <span class="n">_i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># make deep copy of parent query so we can template it</span>
        <span class="n">parent_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_query</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># render the subquery</span>
        <span class="n">parent_query</span> <span class="o">=</span> <span class="n">render_query_base</span><span class="p">(</span><span class="n">hit</span><span class="p">,</span> <span class="n">parent_query</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_parent</span><span class="p">(</span><span class="n">parent_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_match</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">):</span>
            <span class="n">update_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># add labels to each event per index</span>
    <span class="k">for</span> <span class="n">_index</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">update_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># split the update requests into chunks of at most max result window</span>
        <span class="n">update_chunks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ids</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_result_window</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_result_window</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">update_chunks</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">UpdateByQuery</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">_index</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">chunk</span>
            <span class="p">)</span>
            <span class="c1"># apply labels to events</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">apply_labels_by_update_dsl</span><span class="p">(</span>
                <span class="n">update</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_params</span><span class="p">(),</span> <span class="n">update_script_id</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.check_parent">
<code class="highlight language-python"><span class="n">check_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_query</span><span class="p">,</span> <span class="n">min_match</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.check_parent" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Executes a parent query and returns if there were enough result rows.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>parent_query</code></td>
        <td><code>QueryBase</code></td>
        <td><p>The parent query to execute</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>min_match</code></td>
        <td><code>int</code></td>
        <td><p>The minimum number of result rows required</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p><code>True</code> if the query returned &gt;= min_match rows and <code>False</code> otherwise.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_parent</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">parent_query</span><span class="p">:</span> <span class="n">QueryBase</span><span class="p">,</span>
    <span class="n">min_match</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Executes a parent query and returns if there were enough result rows.</span>

<span class="sd">    Args:</span>
<span class="sd">        parent_query: The parent query to execute</span>
<span class="sd">        min_match: The minimum number of result rows required</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>

<span class="sd">    Returns:</span>
<span class="sd">        `True` if the query returned &gt;= min_match rows and `False` otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">resolve_indices</span><span class="p">(</span>
        <span class="n">dataset_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_query</span><span class="o">.</span><span class="n">indices_prefix_dataset</span><span class="p">,</span> <span class="n">parent_query</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">Search</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># ensure we have lists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">parent_query</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent_query</span><span class="o">.</span><span class="n">query</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_query</span><span class="o">.</span><span class="n">filter_</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">parent_query</span><span class="o">.</span><span class="n">filter_</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">parent_query</span><span class="o">.</span><span class="n">filter_</span><span class="p">]</span> <span class="k">if</span> <span class="n">parent_query</span><span class="o">.</span><span class="n">filter_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_query</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">parent_query</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">parent_query</span><span class="o">.</span><span class="n">exclude</span><span class="p">]</span> <span class="k">if</span> <span class="n">parent_query</span><span class="o">.</span><span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">_query</span> <span class="ow">in</span> <span class="n">parent_query</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_filter</span> <span class="ow">in</span> <span class="n">parent_query</span><span class="o">.</span><span class="n">filter_</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_filter</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_exclude</span> <span class="ow">in</span> <span class="n">parent_query</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">_exclude</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">search</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">hits</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">min_match</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateParentQueryRule.update_params">
<code class="highlight language-python"><span class="n">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-inherited"><code>inherited</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateParentQueryRule.update_params" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Gets the update script parameters required for this rule.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, Any]</code></td>
      <td><p>The update script parameters.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets the update script parameters required for this rule.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The update script parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule">
        <code>
UpdateSubQueryRule        </code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-model"><code>pydantic-model</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Labeling rule that labels the results of multiple sub queries.</p>
<p>This labeling rule first executes a base query to retrieve information.
It then renders and executes a templated sub query for each row retrieved
from the base query. The result rows of these dynamically generated sub queries
are then labled.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The sub query uses Jinja2 syntax for templating. The information retrieved
by the base query can be accessed through the <code>HIT</code> variable.</p>
</div>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">elasticsearch.sub_query</span><span class="w"></span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attacker.foothold.apache.access_dropped</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attacker_http</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foothold</span><span class="w"></span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span><span class="w"></span>
<span class="w">    </span><span class="no">This rule tries to match attacker requests that we where unable to</span><span class="w"></span>
<span class="w">    </span><span class="no">match to a labeled response with access log entries. Such cases can</span><span class="w"></span>
<span class="w">    </span><span class="no">happen if the corresponding response gets lost in the network or</span><span class="w"></span>
<span class="w">    </span><span class="no">otherwise is not sent.</span><span class="w"></span>
<span class="w">  </span><span class="nt">index</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pcap-attacker_0</span><span class="w"></span>
<span class="w">  </span><span class="c1"># obligatory match all</span><span class="w"></span>
<span class="w">  </span><span class="nt">query</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">term</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">destination.ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;172.16.0.217&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">filter</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">term</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">event.category</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">term</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">event.action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">request</span><span class="w"></span>
<span class="w">    </span><span class="c1"># we are looking for requests that have not been marked as attacker http yet</span><span class="w"></span>
<span class="w">    </span><span class="c1"># most likely they did not have a matching response due to some network error</span><span class="w"></span>
<span class="w">    </span><span class="c1"># or timeout</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">bool</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">must_not</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">script</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_dataset_kyoushi_label_filter</span><span class="w"></span>
<span class="w">                </span><span class="nt">params</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">attacker_http</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">  </span><span class="nt">sub_query</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">index</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache_access-intranet_server</span><span class="w"></span>
<span class="w">    </span><span class="nt">query</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">term</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">url.full</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">HIT.url.full</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">term</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">source.address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;172.16.100.151&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">filter</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">range</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;@timestamp&quot;</span><span class="p p-Indicator">:</span><span class="w"></span>
<span class="w">            </span><span class="c1"># the access log entry should be after the request, but since the access log</span><span class="w"></span>
<span class="w">            </span><span class="c1"># does not have microseconds we drop them here as well</span><span class="w"></span>
<span class="w">            </span><span class="nt">gte</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">(HIT[&#39;@timestamp&#39;]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">as_datetime).replace(microsecond=0)</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<span class="w">            </span><span class="c1"># the type of error we are looking for should create an access log entry almost immediately</span><span class="w"></span>
<span class="w">            </span><span class="c1"># se we keep the time frame short</span><span class="w"></span>
<span class="w">            </span><span class="nt">lte</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">(</span><span class="nv"> </span><span class="s">HIT[&#39;@timestamp&#39;]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">as_datetime).replace(microsecond=0)</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">timedelta(seconds=1)</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
</code></pre></div>




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.description">
<code class="highlight language-python"><span class="n">description</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.description" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>An optional description for the rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.exclude">
<code class="highlight language-python"><span class="n">exclude</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.exclude" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Similar to filters, but used to exclude results</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.filter_">
<code class="highlight language-python"><span class="n">filter_</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.filter_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The filter/s to limit queried to documents to only those that match the filters</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.id_">
<code class="highlight language-python"><span class="n">id_</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.id_" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The unique rule id</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.index">
<code class="highlight language-python"><span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.index" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The indices to query (by default prefixed with the dataset name)</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.indices_prefix_dataset">
<code class="highlight language-python"><span class="n">indices_prefix_dataset</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.indices_prefix_dataset" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>If set to true the <code>&lt;DATASET.name&gt;-</code> is automatically prefixed to each pattern. This is a convenience setting as per default all dataset indices start with this prefix.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.labels">
<code class="highlight language-python"><span class="n">labels</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.labels" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The list of labels to apply to log lines matching this rule</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.query">
<code class="highlight language-python"><span class="n">query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The query/s to use for identifying log lines to apply the tags to.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.sub_query">
<code class="highlight language-python"><span class="n">sub_query</span><span class="p">:</span> <span class="n">QueryBase</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.sub_query" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The templated sub query to use to apply the labels. Executed for each hit of the parent query.</p>
    </div>

  </div>




  <div class="doc doc-object doc-attribute">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.type_field">
<code class="highlight language-python"><span class="n">type_field</span><span class="p">:</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-pydantic-field"><code>pydantic-field</code></small>
      <small class="doc doc-property doc-property-required"><code>required</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.type_field" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The rule type as passed in from the config</p>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.apply">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">label_object</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.apply" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Applies the labels to all rows matching the created sub queries.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>dataset_dir</code></td>
        <td><code>Path</code></td>
        <td><p>The dataset base directory</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_config</code></td>
        <td><code>DatasetConfig</code></td>
        <td><p>The dataset configuration</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The label update script ID</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The field used to store label information</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of rows the labels were applied to.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="p">:</span> <span class="n">DatasetConfig</span><span class="p">,</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Applies the labels to all rows matching the created sub queries.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_dir: The dataset base directory</span>
<span class="sd">        dataset_config: The dataset configuration</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        update_script_id: The label update script ID</span>
<span class="sd">        label_object: The field used to store label information</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of rows the labels were applied to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">resolve_indices</span><span class="p">(</span>
        <span class="n">dataset_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices_prefix_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>

    <span class="n">search</span> <span class="o">=</span> <span class="n">Search</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># ensure we have lists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="c1"># exclude already correctly labeled rows from the result set</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
        <span class="s2">&quot;term&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_object</span><span class="si">}</span><span class="s2">.flat.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)},</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">_query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_filter</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_exclude</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">_exclude</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">scroll</span><span class="o">=</span><span class="s2">&quot;30m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">scan</span><span class="p">():</span>
        <span class="c1"># make deep copy of sub query so we can template it</span>
        <span class="n">sub_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_query</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># render the subquery</span>
        <span class="n">sub_query</span> <span class="o">=</span> <span class="n">render_query_base</span><span class="p">(</span><span class="n">hit</span><span class="p">,</span> <span class="n">sub_query</span><span class="p">)</span>

        <span class="n">sub_rule</span> <span class="o">=</span> <span class="n">UpdateByQueryRule</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;elasticsearch.query&quot;</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">sub_query</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="n">sub_query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">sub_query</span><span class="o">.</span><span class="n">filter_</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="n">sub_query</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span>
            <span class="n">indices_prefix_dataset</span><span class="o">=</span><span class="n">sub_query</span><span class="o">.</span><span class="n">indices_prefix_dataset</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">sub_rule</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">dataset_config</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">label_object</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="cr_kyoushi.dataset.labels.UpdateSubQueryRule.update_params">
<code class="highlight language-python"><span class="n">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-inherited"><code>inherited</code></small>
  </span>

<a class="headerlink" href="#cr_kyoushi.dataset.labels.UpdateSubQueryRule.update_params" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Gets the update script parameters required for this rule.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, Any]</code></td>
      <td><p>The update script parameters.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets the update script parameters required for this rule.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The update script parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.apply_labels_by_query">
<code class="highlight language-python"><span class="n">apply_labels_by_query</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">script_params</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;_all&#39;</span><span class="p">,</span> <span class="n">check_interval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.apply_labels_by_query" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Utility function for applying labels based on a DSL query.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>query</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>The DSL query dict</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>script_params</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>The parameters for the label update script.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The label update script to use</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>index</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>The indices to query</p></td>
        <td><code>&#39;_all&#39;</code></td>
      </tr>
      <tr>
        <td><code>check_interval</code></td>
        <td><code>float</code></td>
        <td><p>The amount in time between the status checks.</p></td>
        <td><code>0.5</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of updated rows.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply_labels_by_query</span><span class="p">(</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">query</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">script_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_all&quot;</span><span class="p">,</span>
    <span class="n">check_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Utility function for applying labels based on a DSL query.</span>

<span class="sd">    Args:</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        query: The DSL query dict</span>
<span class="sd">        script_params: The parameters for the label update script.</span>
<span class="sd">        update_script_id: The label update script to use</span>
<span class="sd">        index: The indices to query</span>
<span class="sd">        check_interval: The amount in time between the status checks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of updated rows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">UpdateByQuery</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">update_from_dict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">apply_labels_by_update_dsl</span><span class="p">(</span>
        <span class="n">update</span><span class="p">,</span> <span class="n">script_params</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">check_interval</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.apply_labels_by_update_dsl">
<code class="highlight language-python"><span class="n">apply_labels_by_update_dsl</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">script_params</span><span class="p">,</span> <span class="n">update_script_id</span><span class="p">,</span> <span class="n">check_interval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.apply_labels_by_update_dsl" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Utility function for applying labels based on a DSL query object.</p>
<p>The function takes a update by query object and uses the Cyber Range Kyoushi
label update script to apply the given labels to all matching rows. This
function is blocking as it waits for the process to complete.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>update</code></td>
        <td><code>UpdateByQuery</code></td>
        <td><p>The update by query object containing the DSL query.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>script_params</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>The parameters for the label update script.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>update_script_id</code></td>
        <td><code>str</code></td>
        <td><p>The label update script to use</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>check_interval</code></td>
        <td><code>float</code></td>
        <td><p>The amount in time between the status checks.</p></td>
        <td><code>0.5</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of updated rows.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply_labels_by_update_dsl</span><span class="p">(</span>
    <span class="n">update</span><span class="p">:</span> <span class="n">UpdateByQuery</span><span class="p">,</span>
    <span class="n">script_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">update_script_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">check_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Utility function for applying labels based on a DSL query object.</span>

<span class="sd">    The function takes a update by query object and uses the Cyber Range Kyoushi</span>
<span class="sd">    label update script to apply the given labels to all matching rows. This</span>
<span class="sd">    function is blocking as it waits for the process to complete.</span>

<span class="sd">    Args:</span>
<span class="sd">        update: The update by query object containing the DSL query.</span>
<span class="sd">        script_params: The parameters for the label update script.</span>
<span class="sd">        update_script_id: The label update script to use</span>
<span class="sd">        check_interval: The amount in time between the status checks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of updated rows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># refresh=True is important so that consecutive rules</span>
    <span class="c1"># have a consitant state</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">_using</span><span class="p">)</span>

    <span class="c1"># add update script</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">update_script_id</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">script_params</span><span class="p">)</span>

    <span class="c1"># run update task</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wait_for_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">task</span>
    <span class="n">task_info</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">task_info</span><span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">]:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">check_interval</span><span class="p">)</span>
        <span class="n">task_info</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># ToDo: Elasticsearch (7.12) does not provide any API to delete update by query tasks</span>
        <span class="c1">#       The only option is to delete the document directly this will be deprecated</span>
        <span class="c1">#       and as such gives warnings. For now we ignore these and wait for elasticsearch</span>
        <span class="c1">#       to provide an API for it.</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">es</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;.tasks&quot;</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">task_info</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">][</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.create_kyoushi_scripts">
<code class="highlight language-python"><span class="n">create_kyoushi_scripts</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">label_object</span><span class="o">=</span><span class="s1">&#39;kyoushi_labels&#39;</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.create_kyoushi_scripts" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Utility function for creating labeling update, filter and field scripts.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dataset_name</code></td>
        <td><code>str</code></td>
        <td><p>The name of the dataset to create the scripts for.
          This is used as prefix for script names to ensure
          different versions of these scripts can exist for
          different datasets in the same Elasticsearch instance.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The name of field to store labeling information in.</p></td>
        <td><code>&#39;kyoushi_labels&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_kyoushi_scripts</span><span class="p">(</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kyoushi_labels&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Utility function for creating labeling update, filter and field scripts.</span>

<span class="sd">    Args:</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        dataset_name: The name of the dataset to create the scripts for.</span>
<span class="sd">                      This is used as prefix for script names to ensure</span>
<span class="sd">                      different versions of these scripts can exist for</span>
<span class="sd">                      different datasets in the same Elasticsearch instance.</span>
<span class="sd">        label_object: The name of field to store labeling information in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">update_script</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Kyoushi Dataset - Update by Query label script&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;painless&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">UPDATE_SCRIPT</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{{ label_object }}&quot;</span><span class="p">,</span> <span class="n">label_object</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">es</span><span class="o">.</span><span class="n">put_script</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_kyoushi_label_update&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">update_script</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;update&quot;</span>
    <span class="p">)</span>

    <span class="n">filter_script</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;painless&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">LABEL_FILTER_SCRIPT</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{{ label_object }}&quot;</span><span class="p">,</span> <span class="n">label_object</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">es</span><span class="o">.</span><span class="n">put_script</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_kyoushi_label_filter&quot;</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="n">filter_script</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">labels_field</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;painless&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">LABELS_FIELD_SCRIPT</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{{ label_object }}&quot;</span><span class="p">,</span> <span class="n">label_object</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">es</span><span class="o">.</span><span class="n">put_script</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_kyoushi_label_field&quot;</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="n">labels_field</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="s2">&quot;field&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.get_label_counts">
<code class="highlight language-python"><span class="n">get_label_counts</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_object</span><span class="o">=</span><span class="s1">&#39;kyoushi_labels&#39;</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.get_label_counts" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Utility function for getting number of rows per label.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>es</code></td>
        <td><code>Elasticsearch</code></td>
        <td><p>The elasticsearch client object</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>index</code></td>
        <td><code>Union[List[str], str]</code></td>
        <td><p>The indices to get the information for</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>label_object</code></td>
        <td><code>str</code></td>
        <td><p>The field containing the label information</p></td>
        <td><code>&#39;kyoushi_labels&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[elasticsearch_dsl.response.aggs.Bucket]</code></td>
      <td><p>List of result buckets</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_label_counts</span><span class="p">(</span>
    <span class="n">es</span><span class="p">:</span> <span class="n">Elasticsearch</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label_object</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kyoushi_labels&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Bucket</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Utility function for getting number of rows per label.</span>

<span class="sd">    Args:</span>
<span class="sd">        es: The elasticsearch client object</span>
<span class="sd">        index: The indices to get the information for</span>
<span class="sd">        label_object: The field containing the label information</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of result buckets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># disable request cache to ensure we always get latest info</span>
    <span class="n">search_labels</span> <span class="o">=</span> <span class="n">Search</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">request_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">runtime_mappings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span><span class="p">,</span>
            <span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="n">LABELS_AGGREGATES_FIELD_SCRIPT</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">search_labels</span> <span class="o">=</span> <span class="n">search_labels</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">runtime_mappings</span><span class="o">=</span><span class="n">runtime_mappings</span><span class="p">)</span>

    <span class="c1"># setup aggregations</span>
    <span class="n">search_labels</span><span class="o">.</span><span class="n">aggs</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">,</span>
        <span class="s2">&quot;composite&quot;</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;labels&quot;</span><span class="p">}}}],</span>
    <span class="p">)</span>

    <span class="n">search_labels</span><span class="o">.</span><span class="n">aggs</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;terms&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;log.file.path&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scan_composite</span><span class="p">(</span><span class="n">search_labels</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="cr_kyoushi.dataset.labels.render_query_base">
<code class="highlight language-python"><span class="n">render_query_base</span><span class="p">(</span><span class="n">hit</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span></code>


<a class="headerlink" href="#cr_kyoushi.dataset.labels.render_query_base" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Utility function for rendering sub or parent query.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>hit</code></td>
        <td><code>Hit</code></td>
        <td><p>The Elasticsearch query result row to render for.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>query</code></td>
        <td><code>QueryBase</code></td>
        <td><p>The templated query definition.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>QueryBase</code></td>
      <td><p>The rendered DSL query</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>dataset/labels.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">render_query_base</span><span class="p">(</span><span class="n">hit</span><span class="p">:</span> <span class="n">Hit</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">QueryBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryBase</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Utility function for rendering sub or parent query.</span>

<span class="sd">    Args:</span>
<span class="sd">        hit: The Elasticsearch query result row to render for.</span>
<span class="sd">        query: The templated query definition.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The rendered DSL query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;HIT&quot;</span><span class="p">:</span> <span class="n">hit</span><span class="p">}</span>

    <span class="c1"># render the index var</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">query</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
        <span class="n">query</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">render_template</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># ensure we have lists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">query</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">filter_</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">query</span><span class="o">.</span><span class="n">filter_</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="o">.</span><span class="n">filter_</span><span class="p">]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">filter_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="o">.</span><span class="n">exclude</span><span class="p">]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="n">query</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">render_template_recursive</span><span class="p">(</span><span class="n">_query</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span> <span class="k">for</span> <span class="n">_query</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span>
    <span class="p">]</span>
    <span class="n">query</span><span class="o">.</span><span class="n">filter_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">render_template_recursive</span><span class="p">(</span><span class="n">_filter</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span> <span class="k">for</span> <span class="n">_filter</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">filter_</span>
    <span class="p">]</span>
    <span class="n">query</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">render_template_recursive</span><span class="p">(</span><span class="n">_exclude</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span> <span class="k">for</span> <span class="n">_exclude</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">exclude</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">query</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../elasticsearch/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Elasticsearch
              </div>
            </div>
          </a>
        
        
          <a href="../parser/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Parser
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../../js/jquery-3.5.1.min.js"></script>
      
        <script src="../../js/jquery.fancybox.min.js"></script>
      
    
  </body>
</html>